name: Upstream Immich Sync

on:
  schedule:
    # Run every day at 00:30
    - cron: '30 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: upstream-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Fetch latest stable Immich tag
        id: fetch_tag
        run: |
          # Fetch all tags from immich-app/immich
          TAGS=$(git ls-remote --tags --sort='-v:refname' https://github.com/immich-app/immich.git | grep -E 'refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

          if [ -z "$TAGS" ]; then
            exit 1
          fi

          # Extract tag name (format: <sha>	refs/tags/v1.2.3)
          LATEST_TAG=$(echo "$TAGS" | sed 's/.*refs\/tags\///')

          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Read stored upstream tag
        id: stored_tag
        run: |
          STATE_FILE="IMMICH-VERSION"
          STORED_TAG=$(cat "$STATE_FILE" | tr -d '[:space:]')
          echo "stored_tag=$STORED_TAG" >> "$GITHUB_OUTPUT"

      - name: Check if sync is needed
        id: check_sync
        run: |
          if [ "$LATEST_TAG" = "$STORED_TAG" ]; then
            echo "sync_needed=false" >> "$GITHUB_OUTPUT"
            echo "No new tag: $LATEST_TAG"
            exit 0
          fi

          echo "sync_needed=true" >> "$GITHUB_OUTPUT"
          echo "New tag found: $LATEST_TAG (was $STORED_TAG)"
        env:
          LATEST_TAG: ${{ steps.fetch_tag.outputs.latest_tag }}
          STORED_TAG: ${{ steps.stored_tag.outputs.stored_tag }}

      - name: Determine commit message type
        id: commit_msg
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          RELEASE_URL="https://github.com/immich-app/immich/releases/tag/$LATEST_TAG"

          # Remove 'v' prefix for comparison
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          STORED_VERSION=$(echo "$STORED_TAG" | sed 's/^v//')

          # Parse version components
          IFS='.' read -r LATEST_MAJOR LATEST_MINOR LATEST_PATCH <<< "$LATEST_VERSION"
          IFS='.' read -r STORED_MAJOR STORED_MINOR STORED_PATCH <<< "$STORED_VERSION"

          # Determine commit type based on semver diff
          if [ "$LATEST_MAJOR" != "$STORED_MAJOR" ]; then
            # Major version bump
            COMMIT_TYPE="feat"
            COMMIT_BODY="BREAKING CHANGE: Immich server had a major release. Review upstream release notes for potential client-impacting changes."
          elif [ "$LATEST_MINOR" != "$STORED_MINOR" ]; then
            # Minor version bump
            COMMIT_TYPE="feat"
            COMMIT_BODY=""
          else
            # Patch version bump
            COMMIT_TYPE="fix"
            COMMIT_BODY=""
          fi

          echo "commit_type=$COMMIT_TYPE" >> "$GITHUB_OUTPUT"

          # Build commit message
          COMMIT_MESSAGE="$COMMIT_TYPE: sync client to Immich $LATEST_TAG"$'\n\n'"Immich Release Notes: $RELEASE_URL"
          if [ -n "$COMMIT_BODY" ]; then
            COMMIT_MESSAGE="$COMMIT_MESSAGE"$'\n\n'"$COMMIT_BODY"
          fi
          echo "commit_message=$COMMIT_MESSAGE" >> "$GITHUB_OUTPUT"
        env:
          LATEST_TAG: ${{ steps.fetch_tag.outputs.latest_tag }}
          STORED_TAG: ${{ steps.stored_tag.outputs.stored_tag }}

      - name: Compute PR branch name
        id: pr_branch
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # keep it deterministic so create-pull-request can update the same PR
          echo "branch=automation/sync-${LATEST_TAG}" >> "$GITHUB_OUTPUT"
        env:
          LATEST_TAG: ${{ steps.fetch_tag.outputs.latest_tag }}

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Run CI (generate + lint)
        if: steps.check_sync.outputs.sync_needed == 'true'
        env:
          IMMICH_OPENAPI_REF: ${{ steps.fetch_tag.outputs.latest_tag }}
        run: mise run ci

      - name: Update stored tag file
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          echo "$LATEST_TAG" > IMMICH-VERSION
        env:
          LATEST_TAG: ${{ steps.fetch_tag.outputs.latest_tag }}

      - name: Create or update PR (automation branch -> main)
        if: steps.check_sync.outputs.sync_needed == 'true'
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
        with:
          commit-message: ${{ steps.commit_msg.outputs.commit_message }}
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          branch: ${{ steps.pr_branch.outputs.branch }}
          base: main
          title: Sync Immich ${{ steps.fetch_tag.outputs.latest_tag }}
          body: |
            Automatically generated sync to Immich ${{ steps.fetch_tag.outputs.latest_tag }}.

            This PR was created by the upstream sync workflow.

            Upstream tag: https://github.com/immich-app/immich/releases/tag/${{ steps.fetch_tag.outputs.latest_tag }}
          delete-branch: true

