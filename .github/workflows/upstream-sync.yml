name: Upstream Immich Sync

on:
  schedule:
    # Run every day at 00:30
    - cron: '30 0 * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'The tag to sync to'
        required: true
        default: 'latest'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: upstream-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Determine tag to sync
        id: tag_to_use
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$INPUT_TAG" != "latest" ]; then
            echo "Using tag from workflow_dispatch input: $INPUT_TAG"
            TAG="$INPUT_TAG"
          else
            echo "Fetching latest stable tag"
            TAGS=$(git ls-remote --tags --sort='-v:refname' https://github.com/immich-app/immich.git | grep -E 'refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            if [ -z "$TAGS" ]; then
              exit 1
            fi
            TAG=$(echo "$TAGS" | sed 's/.*refs\/tags\///')
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}

      - name: Read stored upstream tag
        id: stored_tag
        run: |
          STATE_FILE="IMMICH-VERSION"
          STORED_TAG=$(cat "$STATE_FILE" | tr -d '[:space:]')
          echo "stored_tag=$STORED_TAG" >> "$GITHUB_OUTPUT"

      - name: Check if sync is needed
        id: check_sync
        run: |
          if [ "$TAG" = "$STORED_TAG" ]; then
            echo "sync_needed=false" >> "$GITHUB_OUTPUT"
            echo "No new tag: $TAG"
            exit 0
          fi

          echo "sync_needed=true" >> "$GITHUB_OUTPUT"
          echo "New tag found: $TAG (was $STORED_TAG)"
        env:
          TAG: ${{ steps.tag_to_use.outputs.tag }}
          STORED_TAG: ${{ steps.stored_tag.outputs.stored_tag }}

      - name: Check for breaking API changes
        id: oasdiff_breaking
        if: steps.check_sync.outputs.sync_needed == 'true'
        continue-on-error: true
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: https://raw.githubusercontent.com/immich-app/immich/refs/tags/${{ steps.stored_tag.outputs.stored_tag }}/open-api/immich-openapi-specs.json
          revision: https://raw.githubusercontent.com/immich-app/immich/refs/tags/${{ steps.tag_to_use.outputs.tag }}/open-api/immich-openapi-specs.json
          fail-on: ERR

      - name: Generate API changelog
        id: oasdiff_changelog
        if: steps.check_sync.outputs.sync_needed == 'true'
        uses: oasdiff/oasdiff-action/changelog@main
        with:
          base: https://raw.githubusercontent.com/immich-app/immich/refs/tags/${{ steps.stored_tag.outputs.stored_tag }}/open-api/immich-openapi-specs.json
          revision: https://raw.githubusercontent.com/immich-app/immich/refs/tags/${{ steps.tag_to_use.outputs.tag }}/open-api/immich-openapi-specs.json
          format: markdown

      - name: Determine commit message type
        id: commit_msg
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          RELEASE_URL="https://github.com/immich-app/immich/releases/tag/$TAG"

          # Remove 'v' prefix for comparison
          LATEST_VERSION=$(echo "$TAG" | sed 's/^v//')
          STORED_VERSION=$(echo "$STORED_TAG" | sed 's/^v//')

          # Parse version components
          IFS='.' read -r LATEST_MAJOR LATEST_MINOR LATEST_PATCH <<< "$LATEST_VERSION"
          IFS='.' read -r STORED_MAJOR STORED_MINOR STORED_PATCH <<< "$STORED_VERSION"

          # Determine commit type based on semver diff
          if [ "$LATEST_MAJOR" != "$STORED_MAJOR" ]; then
            # Major version bump
            COMMIT_TYPE="feat!"
            COMMIT_BODY="BREAKING CHANGE: Immich server had a major release. Review upstream release notes for potential client-impacting changes."
          elif [ "$LATEST_MINOR" != "$STORED_MINOR" ]; then
            # Minor version bump
            COMMIT_TYPE="feat"
            COMMIT_BODY=""
          else
            # Patch version bump
            COMMIT_TYPE="fix"
            COMMIT_BODY=""
          fi

          echo "commit_type=$COMMIT_TYPE" >> "$GITHUB_OUTPUT"

          # Build commit message
          COMMIT_MESSAGE="$COMMIT_TYPE: sync client to [Immich $TAG]($RELEASE_URL)"
          if [ -n "$COMMIT_BODY" ]; then
            COMMIT_MESSAGE="$COMMIT_MESSAGE"$'\n\n'"$COMMIT_BODY"
          fi
          {
            echo "commit_message<<EOF"
            echo "$COMMIT_MESSAGE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          TAG: ${{ steps.tag_to_use.outputs.tag }}
          STORED_TAG: ${{ steps.stored_tag.outputs.stored_tag }}

      - name: Compute PR branch name
        id: pr_branch
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # keep it deterministic so create-pull-request can update the same PR
          echo "branch=automation/sync-${TAG}" >> "$GITHUB_OUTPUT"
        env:
          TAG: ${{ steps.tag_to_use.outputs.tag }}

      - name: Install mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3

      - name: Generate client code
        if: steps.check_sync.outputs.sync_needed == 'true'
        env:
          IMMICH_OPENAPI_REF: ${{ steps.tag_to_use.outputs.tag }}
        run: mise run ci:gen

      - name: Update stored tag file
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          echo "$TAG" > IMMICH-VERSION
        env:
          TAG: ${{ steps.tag_to_use.outputs.tag }}

      - name: Create or update PR
        if: steps.check_sync.outputs.sync_needed == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ secrets.SYNC_PAT }}
          commit-message: ${{ steps.commit_msg.outputs.commit_message }}
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          branch: ${{ steps.pr_branch.outputs.branch }}
          base: main
          title: Sync Immich ${{ steps.tag_to_use.outputs.tag }}
          body: |
            Automatically generated client for [Immich ${{ steps.tag_to_use.outputs.tag }}](https://github.com/immich-app/immich/releases/tag/${{ steps.tag_to_use.outputs.tag }}).

            **Breaking Changes?:** ${{ steps.oasdiff_breaking.outcome == 'failure' }}

            <details>
            <summary>Changelog</summary>

            ${{ steps.oasdiff_changelog.outputs.changelog }}

            </details>

            @coderabbitai ignore
          delete-branch: true
