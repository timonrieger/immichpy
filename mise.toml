[tools]
python = "3.14.2"
uv = "0.9.26"

# https://mise.jdx.dev/mise-cookbook/python.html#mise-uv
[env]
_.python.venv = { path = ".venv" }

[tasks.lint]
run = "uvx pre-commit run --all-files"
description = "Run pre-commit hooks"

[tasks."lint:fix"]
run = "uvx pre-commit run --all-files || true"
description = "Run pre-commit hooks without failing"

[tasks.check]
run = "uv run ty check"
description = "Run type checking"

[tasks."test:unit:cli"]
run = "uv run pytest tests/unit/cli"
description = "Run CLI unit tests with pytest"

[tasks."test:unit:client"]
run = "uv run pytest tests/unit/client"
description = "Run client unit tests with pytest"

[tasks."test:e2e:cli"]
run = "uv run pytest tests/e2e/cli"
description = "Run e2e CLI tests with pytest"

[tasks."test:e2e:client"]
run = "uv run pytest tests/e2e/client"
description = "Run e2e client tests with pytest"

[tasks.install]
run = "uv sync --all-groups --all-extras"
alias = "i"
description = "Install dependencies (alias: 'i')"

[tasks."install:upgrade"]
run = "mise run install --upgrade"
description = "Upgrade dependencies in the allowed ranges"

[tasks."install:check"]
run = "uv tree --outdated --all-groups --depth 1"
description = "Check dependencies for updates"

[tasks.setup]
run = ["mise run install", "uvx pre-commit install"]
description = "Setup the project"

[tasks.build]
run = "uv build"
description = "Build the package"

[tasks."version:dry"]
run = "uvx --from 'python-semantic-release==10' semantic-release --noop -c pyproject.toml version"
description = "Dry run version bump"

[tasks."generate:client"]
description = "Generate Immich API client"
run = '''
set -eu
uv run bin/generate/client.py
'''

[tasks."generate:cli"]
description = "Generate Immich CLI"
run = '''
set -eu
uv run bin/generate/cli.py
'''

[tasks.generate]
description = "Generate Immich API client and CLI"
run = [
    { task = "generate:client" },
    { task = "generate:cli" },
]

[tasks."ci:gen"]
description = "Run generate then lint sequentially (set IMMICH_OPENAPI_REF to a git ref to generate the client and CLI)"
run = [
    { task = "generate" },
    { task = "docs:generate" },
    { task = "lint:fix" },
]

[tasks."ci:check"]
description = "Run lint then check sequentially"
run = [
    { task = "lint" },
    { task = "check" },
]

[tasks."ci:install"]
description = "Install dependencies in CI"
run = ["mise run install --locked"]

[tasks."ci:test:unit"]
description = "Run unit tests in CI"
run = [
    { task = "ci:install" },
    { task = "test:unit:cli" },
    { task = "test:unit:client" },
]

[tasks."ci:test:e2e"]
description = "Run e2e tests in CI"
run = [
    { task = "ci:install" },
    { task = "test:e2e:cli" },
    { task = "test:e2e:client" },
]

[tasks."docs:dev"]
description = "Run documentation development server"
run = "uv run zensical serve"

[tasks."docs:serve"]
hide = true
description = "Run documentation development server (using mkdocs)"
run = "uv run mkdocs serve"

[tasks."docs:build"]
description = "Build documentation for Vercel, pass --prod to build for production"
run = "vercel build --yes"

[tasks."docs:deploy"]
description = "Deploy documentation to Vercel, pass --prod to deploy to production"
run = "vercel deploy --prebuilt"

[tasks."docs:generate:cli"]
description = "Generate documentation for the CLI"
run = [
    { task = "ci:install" },
    "uv run typer immichpy/cli/main.py utils docs --name immichpy --output docs/cli/reference.md --title Reference",
]

[tasks."docs:generate:client"]
description = "Generate documentation for the client"
run = [
"""
set -eu
uv run bin/docs/client.py
"""
]

[tasks."docs:generate"]
description = "Generate documentation for the CLI and client"
run = [
    { task = "docs:generate:cli" },
    { task = "docs:generate:client" },
]
